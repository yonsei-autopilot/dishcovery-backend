<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë©”ë‰´ ì„¤ëª…</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md space-y-4">
      <h1 class="text-xl font-bold">ğŸ“¸ ë©”ë‰´ ì‚¬ì§„ìœ¼ë¡œ ìŒì‹ Bounding Box ë°›ê¸°</h1>

      <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
      <input
        id="imageInput"
        type="file"
        accept="image/*"
        required
        class="block w-full text-sm text-gray-700"
      />

      <!-- ìº”ë²„ìŠ¤ -->
      <canvas
        id="canvas"
        class="w-full border rounded"
        style="display: none"
      ></canvas>

      <!-- ì‹¤í–‰ ë²„íŠ¼ -->
      <button
        id="submitButton"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full"
      >
        ì‹¤í–‰
      </button>

      <!-- ê²°ê³¼ ì˜ì—­ -->
      <div
        id="result"
        class="text-sm text-gray-800 whitespace-pre-line border-t pt-4 min-h-[100px]"
      ></div>
    </div>

    <script>
      const imageInput = document.getElementById("imageInput");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const submitButton = document.getElementById("submitButton");
      const resultDiv = document.getElementById("result");

      let uploadedImage = null; // ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ ì €ì¥ìš©

      // ì´ë¯¸ì§€ê°€ ì„ íƒë˜ì—ˆì„ ë•Œ ì‹¤í–‰
      imageInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          const img = new Image();
          img.onload = function () {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            canvas.style.display = "block"; // ìº”ë²„ìŠ¤ í‘œì‹œ
            uploadedImage = img;
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });

      // ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ë¡œ ì´ë¯¸ì§€ ì „ì†¡
      submitButton.addEventListener("click", async () => {
        if (!uploadedImage) {
          alert("ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
          return;
        }

        // canvas ë‚´ìš©ì„ Blobìœ¼ë¡œ ë³€í™˜
        canvas.toBlob(async (blob) => {
          const formData = new FormData();
          formData.append("image", blob, "uploaded_image.png");

          try {
            submitButton.disabled = true;
            submitButton.classList.add("opacity-50", "cursor-not-allowed");

            const response = await fetch("/menus/bound", {
              // ì„œë²„ì˜ ì—”ë“œí¬ì¸íŠ¸ì— ë§ê²Œ ìˆ˜ì •
              method: "POST",
              body: formData,
            });

            if (response.ok) {
              const result = await response.json();

              console.log(result);

              const boundBox = JSON.parse(result.data.explanation);

              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.drawImage(uploadedImage, 0, 0);

              // bounding box ê·¸ë¦¬ê¸°
              ctx.strokeStyle = "red";
              ctx.lineWidth = 5;
              ctx.font = "64px sans-serif";
              ctx.fillStyle = "red";

              for (const item of boundBox) {
                console.log(item);
                const [y1, x1, y2, x2] = item.box_2d;
                const label = item.label;

                // ì •ê·œí™”ëœ ì¢Œí‘œë¥¼ ìº”ë²„ìŠ¤ í¬ê¸°ë¡œ ë³€í™˜
                const startX = (x1 / 1000) * canvas.width;
                const startY = (y1 / 1000) * canvas.height;
                const endX = (x2 / 1000) * canvas.width;
                const endY = (y2 / 1000) * canvas.height;
                const width = endX - startX;
                const height = endY - startY;

                ctx.strokeRect(startX, startY, width, height);
                ctx.fillText(label, startX + 4, startY + 16); // ìƒì ìœ„ì— ë¼ë²¨
              }
            } else {
              resultDiv.textContent = "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
          } catch (error) {
            console.error(error);
            resultDiv.textContent = "ì „ì†¡ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜";
          } finally {
            submitButton.disabled = false;
            submitButton.classList.remove("opacity-50", "cursor-not-allowed");
          }
        }, "image/png");
      });
    </script>
  </body>
</html>
